import React, { useState, useEffect, useRef } from 'react';
import { BookOpen, Feather, Award, Sun, Moon, FileText, Download, MessageSquare, BrainCircuit, Library, Sparkles, Wand2, ArrowLeft, CheckCircle, LoaderCircle, XCircle, RefreshCw } from 'lucide-react';

// --- بيانات التطبيق ---
const initialLevels = {
  A1: { name: "مدينة المبتدئين", icon: "A1", lessons: 30, color: "bg-sky-500" },
  A2: { name: "واحة الأساسيات", icon: "A2", lessons: 30, color: "bg-teal-500" },
  B1: { name: "جسر المتوسطين", icon: "B1", lessons: 30, color: "bg-amber-500" },
  B2: { name: "هضبة الطلاقة", icon: "B2", lessons: 30, color: "bg-orange-500" },
  C1: { name: "قمة الإتقان", icon: "C1", lessons: 30, color: "bg-red-500" },
};

const initialLessonsData = {
    A1: [ { id: 'A1-1', title: 'Grammar: Verb “to be” (am/is/are) – pronouns', completed: false }, { id: 'A1-2', title: 'Vocabulary: Greetings and introductions', completed: false }, { id: 'A1-3', title: 'Grammar: Plurals', completed: false }, { id: 'A1-4', title: 'Vocabulary: Numbers, colors, shapes', completed: false }, { id: 'A1-5', title: 'Grammar: Articles (a/an/the)', completed: false }, { id: 'A1-6', title: 'Vocabulary: Family and friends', completed: false }, { id: 'A1-7', title: 'Grammar: Possessive adjectives (my, your, his…)', completed: false }, { id: 'A1-8', title: 'Vocabulary: Food and drinks', completed: false }, { id: 'A1-9', title: 'Grammar: This/That/These/Those', completed: false }, { id: 'A1-10', title: 'Review 1: "to be", Articles & Nouns', completed: false }, { id: 'A1-11', title: 'Grammar: There is/There are', completed: false }, { id: 'A1-12', title: 'Vocabulary: Places in town', completed: false }, { id: 'A1-13', title: 'Grammar: Have got/Has got', completed: false }, { id: 'A1-14', title: 'Vocabulary: Transport', completed: false }, { id: 'A1-15', title: 'Grammar: Present Simple (affirmative/negative/questions)', completed: false }, { id: 'A1-16', title: 'Vocabulary: Weather and seasons', completed: false }, { id: 'A1-17', title: 'Grammar: Adverbs of frequency (always, usually…)', completed: false }, { id: 'A1-18', title: 'Vocabulary: Clothes', completed: false }, { id: 'A1-19', title: 'Grammar: Can/Can’t – ability', completed: false }, { id: 'A1-20', title: 'Review 2: Present Simple & "Have got"', completed: false }, { id: 'A1-21', title: 'Grammar: Prepositions of place (in, on, under…)', completed: false }, { id: 'A1-22', title: 'Vocabulary: Daily routines', completed: false }, { id: 'A1-23', title: 'Grammar: Countable & Uncountable nouns + some/any', completed: false }, { id: 'A1-24', title: 'Vocabulary: Hobbies and activities', completed: false }, { id: 'A1-25', title: 'Grammar: Much/Many/A lot of', completed: false }, { id: 'A1-26', title: 'Grammar: Imperatives', completed: false }, { id: 'A1-27', title: 'Grammar: Present Continuous', completed: false }, { id: 'A1-28', title: 'Topic Focus: Describing your room', completed: false }, { id: 'A1-29', title: 'Topic Focus: Ordering food', completed: false }, { id: 'A1-30', title: 'A1 Final Review', completed: false }, ],
    A2: [ { id: 'A2-1', title: 'Grammar: Past Simple (regular & irregular verbs)', completed: false }, { id: 'A2-2', title: 'Vocabulary: Travel and holidays', completed: false }, { id: 'A2-3', title: 'Grammar: Past Simple vs. Past Continuous', completed: false }, { id: 'A2-4', title: 'Vocabulary: Health and illnesses', completed: false }, { id: 'A2-5', title: 'Grammar: Future with “going to” & “will”', completed: false }, { id: 'A2-6', title: 'Vocabulary: Technology and gadgets', completed: false }, { id: 'A2-7', title: 'Grammar: Comparative & Superlative adjectives', completed: false }, { id: 'A2-8', title: 'Vocabulary: Jobs and professions', completed: false }, { id: 'A2-9', title: 'Grammar: Present Continuous for future arrangements', completed: false }, { id: 'A2-10', title: 'Review 1: Past Tenses & Future Forms', completed: false }, { id: 'A2-11', title: 'Grammar: How much/How many', completed: false }, { id: 'A2-12', title: 'Vocabulary: Sports and activities', completed: false }, { id: 'A2-13', title: 'Grammar: Some/Any/No/Every + compounds', completed: false }, { id: 'A2-14', title: 'Vocabulary: Festivals and celebrations', completed: false }, { id: 'A2-15', title: 'Grammar: Object pronouns & Possessive pronouns', completed: false }, { id: 'A2-16', title: 'Vocabulary: Describing people', completed: false }, { id: 'A2-17', title: 'Grammar: Modals: must/mustn’t/have to/don’t have to', completed: false }, { id: 'A2-18', title: 'Vocabulary: Daily actions', completed: false }, { id: 'A2-19', title: 'Grammar: Quantifiers (few, a few, little, a little)', completed: false }, { id: 'A2-20', title: 'Review 2: Modals & Quantifiers', completed: false }, { id: 'A2-21', title: 'Grammar: Adverbs of manner (quickly, slowly…)', completed: false }, { id: 'A2-22', title: 'Vocabulary: International food', completed: false }, { id: 'A2-23', title: 'Grammar: Too/Enough', completed: false }, { id: 'A2-24', title: 'Vocabulary: Shopping and money', completed: false }, { id: 'A2-25', title: 'Grammar: Present Perfect (just, already, yet, ever, never)', completed: false }, { id: 'A2-26', title: 'Topic Focus: Planning a trip', completed: false }, { id: 'A2-27', title: 'Grammar: First Conditional', completed: false }, { id: 'A2-28', title: 'Topic Focus: Talking about experiences', completed: false }, { id: 'A2-29', title: 'Topic Focus: Giving advice', completed: false }, { id: 'A2-30', title: 'A2 Final Review', completed: false }, ],
    B1: [ { id: 'B1-1', title: 'Grammar: Present Perfect Continuous', completed: false }, { id: 'B1-2', title: 'Vocabulary: Social issues', completed: false }, { id: 'B1-3', title: 'Grammar: Past Perfect & Past Perfect Continuous', completed: false }, { id: 'B1-4', title: 'Vocabulary: Environment and climate change', completed: false }, { id: 'B1-5', title: 'Grammar: Future Continuous & Future Perfect', completed: false }, { id: 'B1-6', title: 'Vocabulary: Culture and arts', completed: false }, { id: 'B1-7', title: 'Grammar: Second Conditional', completed: false }, { id: 'B1-8', title: 'Vocabulary: News and media', completed: false }, { id: 'B1-9', title: 'Grammar: Relative clauses (who, which, that, where…)', completed: false }, { id: 'B1-10', title: 'Review 1: Perfect Tenses & Conditionals', completed: false }, { id: 'B1-11', title: 'Grammar: Reported Speech (statements, questions)', completed: false }, { id: 'B1-12', title: 'Vocabulary: Relationships and friendships', completed: false }, { id: 'B1-13', title: 'Grammar: Reported Speech (commands)', completed: false }, { id: 'B1-14', title: 'Vocabulary: Education and learning', completed: false }, { id: 'B1-15', title: 'Grammar: Gerunds & Infinitives', completed: false }, { id: 'B1-16', title: 'Vocabulary: World travel', completed: false }, { id: 'B1-17', title: 'Grammar: Modals for speculation (might, could, can’t + have)', completed: false }, { id: 'B1-18', title: 'Vocabulary: Historical events', completed: false }, { id: 'B1-19', title: 'Grammar: Passive voice (present, past, future)', completed: false }, { id: 'B1-20', title: 'Review 2: Reported Speech & Passives', completed: false }, { id: 'B1-21', title: 'Grammar: Question tags', completed: false }, { id: 'B1-22', title: 'Vocabulary: Advanced technology', completed: false }, { id: 'B1-23', title: 'Grammar: So/Such & Enough/Too + adjectives', completed: false }, { id: 'B1-24', title: 'Vocabulary: Lifestyle and health', completed: false }, { id: 'B1-25', title: 'Grammar: Wish/If only (present & past)', completed: false }, { id: 'B1-26', title: 'Topic Focus: Discussing news', completed: false }, { id: 'B1-27', title: 'Grammar: Causative form (have/get something done)', completed: false }, { id: 'B1-28', title: 'Topic Focus: Talking about regrets', completed: false }, { id: 'B1-29', title: 'Topic Focus: Describing cultural events', completed: false }, { id: 'B1-30', title: 'B1 Final Review', completed: false }, ],
    B2: [ { id: 'B2-1', title: 'Grammar: Mixed Conditionals', completed: false }, { id: 'B2-2', title: 'Vocabulary: Business and corporate terms', completed: false }, { id: 'B2-3', title: 'Grammar: Advanced Passive forms', completed: false }, { id: 'B2-4', title: 'Vocabulary: Economics and finance', completed: false }, { id: 'B2-5', title: 'Grammar: Advanced Modals (deduction, advice, criticism)', completed: false }, { id: 'B2-6', title: 'Vocabulary: Science and inventions', completed: false }, { id: 'B2-7', title: 'Grammar: Inversion for emphasis', completed: false }, { id: 'B2-8', title: 'Vocabulary: Philosophy and abstract ideas', completed: false }, { id: 'B2-9', title: 'Grammar: Future in the past', completed: false }, { id: 'B2-10', title: 'Review 1: Advanced Conditionals & Passives', completed: false }, { id: 'B2-11', title: 'Grammar: Reported Speech (advanced)', completed: false }, { id: 'B2-12', title: 'Vocabulary: Politics and international relations', completed: false }, { id: 'B2-13', title: 'Grammar: Participle clauses', completed: false }, { id: 'B2-14', title: 'Vocabulary: Literary analysis', completed: false }, { id: 'B2-15', title: 'Grammar: Nominalisation', completed: false }, { id: 'B2-16', title: 'Vocabulary: Body language and communication', completed: false }, { id: 'B2-17', title: 'Grammar: Relative clauses (non-defining, reduced)', completed: false }, { id: 'B2-18', title: 'Vocabulary: Debates and discussions', completed: false }, { id: 'B2-19', title: 'Grammar: Subjunctive mood', completed: false }, { id: 'B2-20', title: 'Review 2: Clauses & Advanced Structures', completed: false }, { id: 'B2-21', title: 'Grammar: Complex sentence connectors (although, etc.)', completed: false }, { id: 'B2-22', title: 'Vocabulary: Idiomatic expressions', completed: false }, { id: 'B2-23', title: 'Grammar: Advanced verb patterns', completed: false }, { id: 'B2-24', title: 'Vocabulary: Academic terminology', completed: false }, { id: 'B2-25', title: 'Grammar: Emphatic structures (What I need is…)', completed: false }, { id: 'B2-26', title: 'Topic Focus: Formal debates', completed: false }, { id: 'B2-27', title: 'Grammar: Ellipsis & Substitution', completed: false }, { id: 'B2-28', title: 'Topic Focus: Analyzing a text', completed: false }, { id: 'B2-29', title: 'Grammar: Hedging & Softening language', completed: false }, { id: 'B2-30', title: 'B2 Final Review', completed: false }, ],
    C1: [ { id: 'C1-1', title: 'Grammar: Advanced Conditionals & Hypothetical structures', completed: false }, { id: 'C1-2', title: 'Vocabulary: Legal terminology', completed: false }, { id: 'C1-3', title: 'Grammar: Complex Inversion patterns', completed: false }, { id: 'C1-4', title: 'Vocabulary: Academic research vocabulary', completed: false }, { id: 'C1-5', title: 'Grammar: Advanced Passive transformations', completed: false }, { id: 'C1-6', title: 'Vocabulary: Scientific terminology', completed: false }, { id: 'C1-7', title: 'Grammar: Modals in the past & future for nuance', completed: false }, { id: 'C1-8', title: 'Vocabulary: Figurative and poetic language', completed: false }, { id: 'C1-9', title: 'Grammar: Cleft sentences', completed: false }, { id: 'C1-10', title: 'Review 1: Advanced Grammar Structures', completed: false }, { id: 'C1-11', title: 'Grammar: Advanced linking devices', completed: false }, { id: 'C1-12', title: 'Vocabulary: Advanced medical terms', completed: false }, { id: 'C1-13', title: 'Grammar: Elliptical structures', completed: false }, { id: 'C1-14', title: 'Vocabulary: Specialized journalism language', completed: false }, { id: 'C1-15', title: 'Grammar: Subjunctive in formal contexts', completed: false }, { id: 'C1-16', title: 'Vocabulary: Political rhetoric', completed: false }, { id: 'C1-17', title: 'Grammar: Nominal clauses', completed: false }, { id: 'C1-18', title: 'Vocabulary: Nuanced emotional expressions', completed: false }, { id: 'C1-19', title: 'Grammar: Advanced reported speech nuances', completed: false }, { id: 'C1-20', title: 'Review 2: Clauses & Formal Language', completed: false }, { id: 'C1-21', title: 'Grammar: Mixed verb patterns with subtle meaning changes', completed: false }, { id: 'C1-22', title: 'Vocabulary: Creative writing vocabulary', completed: false }, { id: 'C1-23', title: 'Grammar: Relative clauses with prepositions', completed: false }, { id: 'C1-24', title: 'Vocabulary: Critical and analytical expression', completed: false }, { id: 'C1-25', title: 'Grammar: Emphasis & word order shifts', completed: false }, { id: 'C1-26', title: 'Topic Focus: Academic writing style', completed: false }, { id: 'C1-27', title: 'Grammar: Hedging for academic writing', completed: false }, { id: 'C1-28', title: 'Topic Focus: Public speaking', completed: false }, { id: 'C1-29', title: 'Grammar: Advanced discourse markers', completed: false }, { id: 'C1-30', title: 'C1 Final Review & Prep for C2', completed: false }, ],
};

const placementTestQuestions = [ { question: "The children ___ playing in the garden.", options: ["is", "are", "am", "be"], answer: "are" }, { question: "I haven't seen him ___ last year.", options: ["since", "for", "from", "at"], answer: "since" }, { question: "If I ___ you, I would study harder.", options: ["was", "am", "were", "be"], answer: "were" }, { question: "She is interested ___ learning Spanish.", options: ["in", "on", "at", "for"], answer: "in" }, { question: "This is the ___ movie I have ever seen.", options: ["good", "better", "best", "well"], answer: "best" }, { question: "He drove ___ to avoid the traffic.", options: ["careful", "carefully", "care", "caring"], answer: "carefully" }, { question: "I wish I ___ fly.", options: ["can", "could", "would", "should"], answer: "could" }, { question: "The book is on the table, ___ it?", options: ["is", "isn't", "are", "aren't"], answer: "isn't" }, { question: "They ___ to the cinema yesterday.", options: ["go", "goes", "went", "gone"], answer: "went" }, { question: "My brother is taller ___ me.", options: ["that", "than", "then", "as"], answer: "than" }, { question: "We have ___ milk left.", options: ["a little", "a few", "many", "much"], answer: "a little" }, { question: "She ___ a beautiful song.", options: ["sing", "sings", "sang", "sung"], answer: "sang" }, { question: "I'm looking forward ___ you.", options: ["to see", "seeing", "to seeing", "see"], answer: "to seeing" }, { question: "Despite ___ tired, he finished the race.", options: ["be", "being", "was", "is"], answer: "being" }, { question: "The key ___ on the counter.", options: ["is", "are", "were", "be"], answer: "is" }, ];

const initialReadingMaterials = [ { id: 1, type: 'Story', title: 'The Lost Compass', content: "In a small village nestled between rolling hills, a young boy named Leo found an old brass compass. It didn't point north. Instead, it whispered directions to forgotten places and lost memories. One day, it led him to an ancient oak tree with a hidden door at its base. He opened it, and a wave of starlight and forgotten songs washed over him. He realized the compass didn't find places, but moments of wonder. He learned that the greatest adventures are not on a map, but in the heart.", questions: ["What does the compass guide Leo to?", "What is the main lesson Leo learned?", "How would you describe the mood of the story?"] }, { id: 2, type: 'Article', title: 'The Power of Sleep', content: "Sleep is not just a period of rest; it's a critical biological process. During sleep, our brains consolidate memories, process information, and clear out metabolic waste. A lack of quality sleep can impair cognitive function, weaken the immune system, and affect our mood. Scientists recommend 7-9 hours of sleep for adults for optimal health. It's as important as a balanced diet and regular exercise. Prioritizing sleep is an investment in your physical and mental well-being.", questions: ["What are three benefits of sleep mentioned in the article?", "Why is sleep compared to diet and exercise?", "How can you improve your own sleep habits based on this text?"] }, ];

// --- Gemini API Helper ---
async function runGemini(prompt, schema) {
    const apiKey = process.env.REACT_APP_GEMINI_API_KEY;
    if (!apiKey) {
        console.error("Gemini API key is not set!");
        throw new Error("API key is missing.");
    }
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
    const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
    };
    try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorBody = await response.text(); console.error("API Error Body:", errorBody);
            throw new Error(`API request failed with status ${response.status}`);
        }
        const result = await response.json();
        if (!result.candidates || result.candidates.length === 0) { throw new Error("No candidates returned from API."); }
        const jsonText = result.candidates[0].content.parts[0].text;
        return JSON.parse(jsonText);
    } catch (error) {
        console.error("Error calling Gemini API:", error);
        throw error;
    }
}

// --- المكونات الفرعية ---

const WelcomeScreen = ({ onStart }) => ( <div className="text-center flex flex-col items-center justify-center h-full animate-fade-in"> <BrainCircuit size={80} className="text-sky-500 dark:text-sky-400 mb-6" /> <h1 className="text-4xl md:text-5xl font-bold text-slate-800 dark:text-slate-100 mb-4">رحلة عبور اللغة</h1> <p className="text-lg text-slate-600 dark:text-slate-300 mb-8 max-w-lg">منصة متكاملة تأخذك في رحلة منظمة من A1 إلى C1، مع التركيز على الفهم والتعبير.</p> <button onClick={onStart} className="bg-sky-500 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-sky-600 transition-all duration-300 transform hover:scale-105 shadow-lg">ابدأ رحلتك الآن ✨</button> </div> );

const PlacementTest = ({ onTestComplete }) => {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [score, setScore] = useState(0);
  const [showResult, setShowResult] = useState(false);

  const handleAnswer = (selectedOption) => {
    if (selectedOption === placementTestQuestions[currentQuestion].answer) {
      setScore(score + 1);
    }
    if (currentQuestion < placementTestQuestions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      setShowResult(true);
    }
  };

  if (showResult) {
    let level;
    const percentage = (score / placementTestQuestions.length) * 100;
    if (percentage <= 20) level = 'A1';
    else if (percentage <= 40) level = 'A2';
    else if (percentage <= 60) level = 'B1';
    else if (percentage <= 80) level = 'B2';
    else level = 'C1';

    return (
      <div className="text-center animate-fade-in p-6">
        <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-4">اكتمل الاختبار!</h2>
        <p className="text-lg text-slate-600 dark:text-slate-300 mb-2">نتيجتك: {score} من {placementTestQuestions.length}</p>
        <p className="text-xl font-semibold text-slate-700 dark:text-slate-200 mb-6">
          تم تحديد مستواك المبدئي: <span className="text-sky-500 dark:text-sky-400 font-bold">{level} - {initialLevels[level].name}</span>
        </p>
        <button
          onClick={() => onTestComplete(level)}
          className="bg-sky-500 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-sky-600 transition-all duration-300 transform hover:scale-105"
        >
          اذهب إلى لوحة التحكم
        </button>
      </div>
    );
  }

  const progress = ((currentQuestion + 1) / placementTestQuestions.length) * 100;

  return (
    <div className="p-4 md:p-8 w-full max-w-2xl mx-auto animate-fade-in">
      <h2 className="text-2xl font-bold text-center text-slate-800 dark:text-slate-100 mb-2">اختبار تحديد المستوى الذكي</h2>
      <p className="text-center text-slate-500 dark:text-slate-400 mb-6">السؤال {currentQuestion + 1} من {placementTestQuestions.length}</p>
      
      <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
        <div className="bg-sky-500 h-2.5 rounded-full" style={{ width: `${progress}%`, transition: 'width 0.3s ease-in-out' }}></div>
      </div>

      <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
        <p dir="auto" className="text-xl text-slate-700 dark:text-slate-200 mb-6 min-h-[60px] text-left">{placementTestQuestions[currentQuestion].question}</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {placementTestQuestions[currentQuestion].options.map((option, index) => (
            <button
              key={index}
              onClick={() => handleAnswer(option)}
              className="w-full text-left p-4 rounded-lg border-2 border-slate-200 dark:border-slate-700 hover:bg-sky-100 dark:hover:bg-slate-700 hover:border-sky-500 dark:hover:border-sky-400 transition-all duration-200"
            >
              {option}
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

const Dashboard = ({ userLevel, onLevelSelect, lessonsData }) => { return ( <div className="p-4 md:p-8 animate-fade-in"> <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">مسارات التعلم (المدن اللغوية)</h1> <p className="text-slate-600 dark:text-slate-300 mb-8">رحلتك تبدأ هنا. كل مدينة تمثل مستوى جديداً من الإتقان.</p> <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {Object.entries(initialLevels).map(([key, level]) => { const isLocked = Object.keys(initialLevels).indexOf(key) > Object.keys(initialLevels).indexOf(userLevel); const levelLessons = lessonsData[key] || []; const completedCount = levelLessons.filter(l => l.completed).length; const progress = levelLessons.length > 0 ? (completedCount / levelLessons.length) * 100 : 0; return ( <div key={key} onClick={() => !isLocked && onLevelSelect(key)} className={`p-6 rounded-xl shadow-md transition-all duration-300 transform hover:-translate-y-1 ${isLocked ? 'bg-slate-200 dark:bg-slate-700 cursor-not-allowed' : `${level.color} text-white cursor-pointer`}`}> <div className="flex justify-between items-start"> <div className="text-5xl font-bold">{level.icon}</div> {isLocked && <span className="text-xs bg-slate-500 text-white px-2 py-1 rounded-full">🔒 مغلق</span>} </div> <h3 className="text-2xl font-bold mt-4">{level.name}</h3> <p className="opacity-80 mt-1">{level.lessons} درسًا</p> {!isLocked && ( <div className="mt-4"> <div className="w-full bg-white/30 rounded-full h-2.5"><div className="bg-white h-2.5 rounded-full" style={{ width: `${progress}%` }}></div></div> <p className="text-sm mt-1 opacity-90">{Math.round(progress)}% مكتمل</p> </div> )} </div> ); })} </div> </div> ); };

const LessonView = ({ levelId, onBack, onSelectLesson, lessons }) => { const level = initialLevels[levelId]; const completedCount = lessons.filter(l => l.completed).length; const progress = lessons.length > 0 ? (completedCount / lessons.length) * 100 : 0; return ( <div className="p-4 md:p-8 animate-fade-in"> <button onClick={onBack} className="flex items-center gap-2 text-sky-500 dark:text-sky-400 hover:underline mb-6 font-semibold"><ArrowLeft size={20} /> العودة إلى المسارات</button> <div className="flex items-center gap-4 mb-4"> <div className={`w-16 h-16 rounded-lg ${level.color} flex items-center justify-center text-white text-4xl font-bold`}>{level.icon}</div> <div> <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100">{level.name}</h1> <p className="text-slate-600 dark:text-slate-300">المستوى: {levelId}</p> </div> </div> <div className="mb-8"> <p className="text-slate-700 dark:text-slate-200 mb-2">التقدم: {Math.round(progress)}%</p> <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4"><div className={`${level.color} h-4 rounded-full`} style={{ width: `${progress}%` }}></div></div> </div> <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-4">قائمة الدروس</h2> <div className="space-y-3"> {lessons.map(lesson => ( <div key={lesson.id} className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm flex items-center justify-between transition-all hover:shadow-md hover:scale-[1.02]"> <div className="flex items-center gap-4"> <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${lesson.completed ? 'bg-green-500 text-white' : 'bg-slate-200 dark:bg-slate-700'}`}>{lesson.completed ? <CheckCircle size={20}/> : lesson.id.split('-')[1]}</div> <span className={`font-medium ${lesson.completed ? 'text-slate-400 dark:text-slate-500 line-through' : 'text-slate-700 dark:text-slate-200'}`}>{lesson.title}</span> </div> <button onClick={() => onSelectLesson(lesson)} className="text-sm font-semibold text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300">ابدأ</button> </div> ))} </div> </div> ); };

const QuizView = ({ quiz, onQuizComplete }) => { const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); const [score, setScore] = useState(0); const [selectedOption, setSelectedOption] = useState(null); const [isAnswered, setIsAnswered] = useState(false); const handleAnswer = (option) => { if (isAnswered) return; setSelectedOption(option); setIsAnswered(true); if (option === quiz[currentQuestionIndex].correctAnswer) { setScore(score + 1); } }; const handleNext = () => { if (currentQuestionIndex < quiz.length - 1) { setCurrentQuestionIndex(currentQuestionIndex + 1); setIsAnswered(false); setSelectedOption(null); } else { onQuizComplete(score, quiz.length); } }; const getButtonClass = (option) => { if (!isAnswered) return 'bg-white dark:bg-slate-700 hover:bg-sky-100 dark:hover:bg-slate-600'; if (option === quiz[currentQuestionIndex].correctAnswer) return 'bg-green-200 dark:bg-green-800 border-green-500'; if (option === selectedOption) return 'bg-red-200 dark:bg-red-800 border-red-500'; return 'bg-slate-100 dark:bg-slate-800 opacity-60'; }; const currentQuestion = quiz[currentQuestionIndex]; return ( <div className="animate-fade-in"> <p className="text-center font-semibold text-slate-600 dark:text-slate-300 mb-2">السؤال {currentQuestionIndex + 1} من {quiz.length}</p> <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md"> <h3 dir="auto" className="text-xl text-slate-800 dark:text-slate-100 mb-6 min-h-[56px]">{currentQuestion.question}</h3> <div className="space-y-3"> {currentQuestion.options.map((option, i) => ( <button key={i} onClick={() => handleAnswer(option)} disabled={isAnswered} className={`w-full text-left p-4 rounded-lg border-2 transition-all duration-300 ${getButtonClass(option)}`}> {option} </button> ))} </div> {isAnswered && ( <button onClick={handleNext} className="mt-6 w-full bg-sky-500 text-white font-bold py-3 rounded-lg hover:bg-sky-600 transition-all"> {currentQuestionIndex < quiz.length - 1 ? 'السؤال التالي' : 'عرض النتيجة'} </button> )} </div> </div> ); };

const LessonContent = ({ lesson, onBack, onCompleteLesson }) => { const [lessonContent, setLessonContent] = useState(null); const [quiz, setQuiz] = useState(null); const [view, setView] = useState('lesson'); const [isLoading, setIsLoading] = useState({ lesson: true, quiz: false }); const [error, setError] = useState(''); const [quizResult, setQuizResult] = useState({ score: 0, total: 0 }); useEffect(() => { const generateLessonContent = async () => { setIsLoading(prev => ({ ...prev, lesson: true })); setError(''); const level = lesson.id.substring(0, 2); const prompt = `You are an expert English teacher. For the lesson titled "${lesson.title}", generate a JSON object for a ${level}-level student with two keys: "explanation" (a clear explanation formatted into paragraphs separated by '\\n') and "examples" (an array of exactly 15 practical example sentences).`; const schema = { type: "OBJECT", properties: { explanation: { type: "STRING" }, examples: { type: "ARRAY", items: { type: "STRING" } } }, required: ["explanation", "examples"] }; try { const result = await runGemini(prompt, schema); setLessonContent(result); } catch (e) { setError('عذرًا، فشل تحميل محتوى الدرس.'); } finally { setIsLoading(prev => ({ ...prev, lesson: false })); } }; generateLessonContent(); }, [lesson]); const handleStartQuiz = async () => { setIsLoading(prev => ({ ...prev, quiz: true })); setError(''); const prompt = `Based on the English lesson about "${lesson.title}" and its explanation "${lessonContent.explanation}", create a JSON object containing a single key "quiz". The value should be an array of 5 multiple-choice questions. Each question object must have three keys: "question" (string), "options" (an array of 4 strings), and "correctAnswer" (a string that exactly matches one of the options).`; const schema = { type: "OBJECT", properties: { quiz: { type: "ARRAY", items: { type: "OBJECT", properties: { question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswer: { type: "STRING" } }, required: ["question", "options", "correctAnswer"] } } }, required: ["quiz"] }; try { const result = await runGemini(prompt, schema); setQuiz(result.quiz); setView('quiz'); } catch (e) { setError('عذرًا، فشل إنشاء الاختبار.'); } finally { setIsLoading(prev => ({ ...prev, quiz: false })); } }; const handleQuizComplete = (score, total) => { setQuizResult({ score, total }); setView('result'); }; const handleLessonCompletion = () => { onCompleteLesson(lesson.id); onBack(); }; return ( <div className="p-4 md:p-8 animate-fade-in"> <button onClick={onBack} className="flex items-center gap-2 text-sky-500 dark:text-sky-400 hover:underline mb-6 font-semibold"><ArrowLeft size={20} /> العودة إلى قائمة الدروس</button> <h1 className="text-4xl font-bold text-slate-800 dark:text-slate-100 mb-4">{lesson.title}</h1> {isLoading.lesson && <div className="flex flex-col items-center justify-center bg-white dark:bg-slate-800 p-10 rounded-xl shadow-md"><LoaderCircle className="animate-spin text-sky-500" size={48} /><p className="mt-4 text-lg font-semibold text-slate-600 dark:text-slate-300">يقوم Gemini بإعداد الدرس لك...</p></div>} {error && !isLoading.lesson && <div className="bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-4 rounded-md" role="alert"><p className="font-bold">حدث خطأ</p><p>{error}</p></div>} {view === 'lesson' && lessonContent && ( <div className="animate-fade-in"> <div className="prose dark:prose-invert max-w-none mt-6 text-lg text-left leading-relaxed bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md"> <h2 className="text-2xl font-bold">Explanation</h2><p style={{ whiteSpace: 'pre-wrap' }}>{lessonContent.explanation}</p> <h3 className="text-xl font-bold mt-6">Examples</h3><ol className="list-decimal pr-5 space-y-2">{lessonContent.examples.map((ex, i) => <li key={i}>{ex}</li>)}</ol> </div> <div className="mt-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-md"> <h3 className="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2">🧠 اختبر معلوماتك</h3> <p className="text-slate-600 dark:text-slate-300 mb-4">هل أنت مستعد لاختبار فهمك لهذا الدرس؟</p> <button onClick={handleStartQuiz} disabled={isLoading.quiz} className="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600 transition-all flex items-center justify-center gap-2 disabled:bg-slate-400"> {isLoading.quiz ? <LoaderCircle className="animate-spin" /> : <><Sparkles size={18} /> ابدأ الاختبار</>} </button> </div> </div> )} {view === 'quiz' && quiz && <QuizView quiz={quiz} onQuizComplete={handleQuizComplete} />} {view === 'result' && ( <div className="mt-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-md text-center animate-fade-in"> <h3 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">اكتمل الاختبار!</h3> <p className="text-lg text-slate-600 dark:text-slate-300">نتيجتك هي:</p> <p className="text-6xl font-bold my-4 text-sky-500 dark:text-sky-400">{quizResult.score} / {quizResult.total}</p> {quizResult.score / quizResult.total >= 0.8 ? ( <p className="text-green-600 dark:text-green-400 font-semibold">🎉 رائع! لقد أتقنت هذا الدرس.</p> ) : ( <p className="text-amber-600 dark:text-amber-400 font-semibold">👍 جيد! يمكنك مراجعة الدرس مرة أخرى لتعزيز فهمك.</p> )} <button onClick={handleLessonCompletion} className="mt-6 w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all">إكمال الدرس والعودة</button> </div> )} </div> ); };

const WritingSection = () => { const [text, setText] = useState(''); const [correction, setCorrection] = useState(null); const [isLoading, setIsLoading] = useState(false); const [error, setError] = useState(''); const handleCorrect = async () => { if (!text.trim()) return; setIsLoading(true); setCorrection(null); setError(''); const prompt = `You are an expert English teacher. Please correct the following text from a language learner. Provide three things in a JSON object: 1. "correctedText": The original text with grammar and spelling mistakes fixed. 2. "improvedText": A more fluent, natural-sounding version of the text. 3. "suggestions": An array of 3-4 specific, constructive suggestions for improvement, explaining the 'why' behind the changes. Here is the text: "${text}"`; const schema = { type: "OBJECT", properties: { correctedText: { type: "STRING" }, improvedText: { type: "STRING" }, suggestions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["correctedText", "improvedText", "suggestions"] }; try { const result = await runGemini(prompt, schema); setCorrection(result); } catch (e) { setError("عذرًا، حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى المحاولة مرة أخرى."); } finally { setIsLoading(false); } }; return ( <div className="p-4 md:p-8 animate-fade-in"> <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2 flex items-center gap-3"><Feather /> قسم الكتابة الإبداعي</h1> <p className="text-slate-600 dark:text-slate-300 mb-6">مساحة حرة للكتابة. اكتب أي شيء، ودع Gemini يساعدك على التحسين.</p> <div className="grid grid-cols-1 lg:grid-cols-2 gap-6"> <div> <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="اكتب نصك هنا باللغة الإنجليزية..." className="w-full h-64 p-4 border-2 border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 focus:ring-2 focus:ring-sky-500 focus:outline-none transition-all"></textarea> <button onClick={handleCorrect} disabled={isLoading} className="mt-4 w-full bg-sky-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-600 transition-all duration-300 disabled:bg-slate-400 flex items-center justify-center gap-2"> {isLoading ? <LoaderCircle className="animate-spin" /> : <><Sparkles size={18} /> صحح وحسّن النص</>} </button> </div> <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md min-h-[320px]"> <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4">نتائج تحليل Gemini</h3> {isLoading && <p className="text-slate-500 dark:text-slate-400 flex items-center gap-2"><Wand2 className="animate-pulse" /> يقوم Gemini بتحليل النص...</p>} {error && <p className="text-red-500">{error}</p>} {correction && ( <div className="animate-fade-in space-y-4"> <div><h4 className="font-semibold text-slate-700 dark:text-slate-200">النص المُصحح:</h4><p className="text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/50 p-3 rounded-md">{correction.correctedText}</p></div> <div><h4 className="font-semibold text-slate-700 dark:text-slate-200">نسخة مُحسّنة:</h4><p className="text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/50 p-3 rounded-md">{correction.improvedText}</p></div> <div><h4 className="font-semibold text-slate-700 dark:text-slate-200">اقتراحات للتحسين:</h4><ul className="list-disc list-inside space-y-1 text-slate-600 dark:text-slate-300">{correction.suggestions.map((s, i) => <li key={i}>{s}</li>)}</ul></div> </div> )} {!isLoading && !correction && !error && <p className="text-slate-500 dark:text-slate-400">ستظهر النتائج هنا بعد التصحيح.</p>} </div> </div> </div> ); };

const ReadingCenter = () => { const [materials, setMaterials] = useState(initialReadingMaterials); const [selectedMaterial, setSelectedMaterial] = useState(null); const [isGenerating, setIsGenerating] = useState(false); const [error, setError] = useState(''); const [genre, setGenre] = useState('Sci-Fi'); const handleGenerateStory = async () => { setIsGenerating(true); setError(''); const prompt = `You are a creative storyteller. Generate a short story for a B1-level English language learner. The story should be about 150 words long and belong to the "${genre}" genre. Also, provide 3 open-ended comprehension questions about the story. Return the result as a JSON object with three keys: "title", "content", and "questions" (an array of strings).`; const schema = { type: "OBJECT", properties: { title: { type: "STRING" }, content: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["title", "content", "questions"] }; try { const result = await runGemini(prompt, schema); const newStory = { id: Date.now(), type: 'Story', ...result }; setMaterials(prev => [newStory, ...prev]); } catch (e) { setError("فشلت عملية توليد القصة. يرجى المحاولة مرة أخرى."); } finally { setIsGenerating(false); } }; if (selectedMaterial) { return ( <div className="p-4 md:p-8 animate-fade-in"> <button onClick={() => setSelectedMaterial(null)} className="mb-6 text-sky-500 dark:text-sky-400 hover:underline flex items-center"><ArrowLeft size={16} className="mr-1" /> العودة إلى المكتبة</button> <h2 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">{selectedMaterial.title}</h2> <span className={`text-sm font-semibold px-3 py-1 rounded-full ${selectedMaterial.type === 'Story' ? 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300' : 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-300'}`}>{selectedMaterial.type}</span> <div className="prose dark:prose-invert max-w-none mt-6 text-lg text-left leading-relaxed bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md"><p>{selectedMaterial.content}</p></div> <div className="mt-8"><h3 className="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-4">أسئلة للتفكير 🤔</h3><div className="space-y-4">{selectedMaterial.questions.map((q, i) => (<div key={i} className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm"><p className="text-slate-700 dark:text-slate-200">{q}</p></div>))}</div></div> </div> ); } return ( <div className="p-4 md:p-8 animate-fade-in"> <div className="flex flex-wrap justify-between items-center gap-4 mb-8"> <div><h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">📖 مركز القراءة والتأمل</h1><p className="text-slate-600 dark:text-slate-300">اقرأ قصصًا ومقالات متنوعة، أو قم بتوليد محتوى جديد بنفسك.</p></div> <div className="flex items-center gap-2 bg-white dark:bg-slate-800 p-2 rounded-lg shadow-sm"> <select value={genre} onChange={e => setGenre(e.target.value)} className="bg-transparent focus:outline-none"><option>Sci-Fi</option><option>Mystery</option><option>Adventure</option><option>Comedy</option></select> <button onClick={handleGenerateStory} disabled={isGenerating} className="bg-amber-500 text-white font-bold py-2 px-4 rounded-md hover:bg-amber-600 transition-all duration-300 disabled:bg-slate-400 flex items-center justify-center gap-2"> {isGenerating ? <LoaderCircle className="animate-spin" /> : <><Sparkles size={16} /> توليد قصة</>} </button> </div> </div> {error && <p className="text-red-500 mb-4">{error}</p>} <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {materials.map(material => (<div key={material.id} onClick={() => setSelectedMaterial(material)} className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all duration-300"> <span className={`text-xs font-semibold px-2 py-1 rounded-full ${material.type === 'Story' ? 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300' : 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-300'}`}>{material.type}</span> <h3 className="text-xl font-bold mt-3 text-slate-800 dark:text-slate-100">{material.title}</h3> <p className="text-slate-500 dark:text-slate-400 mt-2 line-clamp-3">{material.content}</p> </div>))} </div> </div> ); };

const Certificate = () => { return ( <div className="p-4 md:p-8 animate-fade-in text-center flex flex-col items-center"> <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100 mb-2">🏆 الشهادات</h1> <p className="text-slate-600 dark:text-slate-300 mb-6">عند اجتياز كل "بوابة عبور"، ستحصل على شهادة هنا.</p> <div className="w-full max-w-2xl aspect-[1.414] bg-white dark:bg-slate-800 border-4 border-slate-300 dark:border-slate-700 p-8 rounded-lg shadow-2xl relative flex items-center justify-center"> <p className="text-slate-500 dark:text-slate-400">أكمل مستوى B1 للحصول على شهادتك الأولى!</p> </div> </div> ); };


// --- المكون الرئيسي للتطبيق ---
export default function App() {
  const [page, setPage] = useState('welcome');
  const [userLevel, setUserLevel] = useState('A1');
  const [selectedLevelId, setSelectedLevelId] = useState(null);
  const [currentLesson, setCurrentLesson] = useState(null);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [lessonsDataState, setLessonsDataState] = useState(initialLessonsData);

  useEffect(() => {
    if (isDarkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [isDarkMode]);

  const handleCompleteLesson = (lessonId) => {
      const levelId = lessonId.substring(0, 2);
      setLessonsDataState(prevData => ({
          ...prevData,
          [levelId]: prevData[levelId].map(lesson => 
              lesson.id === lessonId ? { ...lesson, completed: true } : lesson
          )
      }));
  };
  
  const handleTestComplete = (level) => {
    setUserLevel(level);
    setPage('dashboard');
  };

  const handleLevelSelect = (levelId) => { setSelectedLevelId(levelId); setPage('lessons'); };
  const handleSelectLesson = (lesson) => { setCurrentLesson(lesson); setPage('lessonContent'); };
  const handleBackToDashboard = () => { setSelectedLevelId(null); setCurrentLesson(null); setPage('dashboard'); }
  const handleBackToLessons = () => { setCurrentLesson(null); setPage('lessons'); }

  const renderPage = () => {
    switch (page) {
      case 'welcome': return <WelcomeScreen onStart={() => setPage('test')} />;
      case 'test': return <PlacementTest onTestComplete={handleTestComplete} />;
      case 'dashboard': return <Dashboard userLevel={userLevel} onLevelSelect={handleLevelSelect} lessonsData={lessonsDataState} />;
      case 'lessons': return <LessonView levelId={selectedLevelId} onBack={handleBackToDashboard} onSelectLesson={handleSelectLesson} lessons={lessonsDataState[selectedLevelId]} />;
      case 'lessonContent': return <LessonContent lesson={currentLesson} onBack={handleBackToLessons} onCompleteLesson={handleCompleteLesson} />;
      case 'writing': return <WritingSection />;
      case 'reading': return <ReadingCenter />;
      case 'certificate': return <Certificate />;
      default: return <WelcomeScreen onStart={() => setPage('dashboard')} />;
    }
  };

  const navItems = [
    { id: 'dashboard', label: 'الرئيسية', icon: BookOpen },
    { id: 'writing', label: 'كتابة', icon: Feather },
    { id: 'reading', label: 'قراءة', icon: Library },
    { id: 'certificate', label: 'الشهادات', icon: Award },
  ];

  return (
    <div className={`min-h-screen ${isDarkMode ? 'dark' : ''}`}>
      <div className="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300 font-sans">
        <header className="sticky top-0 z-10 bg-white/70 dark:bg-slate-900/70 backdrop-blur-lg shadow-sm">
          <nav className="container mx-auto px-4 md:px-6 py-3 flex justify-between items-center">
            <div className="flex items-center gap-2 cursor-pointer" onClick={handleBackToDashboard}><BrainCircuit className="text-sky-500 dark:text-sky-400" size={28} /><span className="text-xl font-bold text-slate-800 dark:text-slate-100">رحلة عبور</span></div>
            <div className="hidden md:flex items-center gap-6">
              {navItems.map(item => (
                <button key={item.id} onClick={() => setPage(item.id)} className={`flex items-center gap-2 font-semibold transition-colors ${page.startsWith('lesson') && item.id === 'dashboard' ? 'text-sky-500 dark:text-sky-400' : page === item.id ? 'text-sky-500 dark:text-sky-400' : 'text-slate-600 dark:text-slate-300 hover:text-sky-500 dark:hover:text-sky-400'}`}><item.icon size={20} />{item.label}</button>
              ))}
            </div>
            <div className="flex items-center gap-4"><button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}</button></div>
          </nav>
        </header>
        <main className="container mx-auto px-4 md:px-6 py-8 pb-24 md:pb-8">{renderPage()}</main>
        <footer className="md:hidden fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 p-2">
            <div className="flex justify-around items-center">
            {navItems.map(item => (
                <button key={item.id} onClick={() => setPage(item.id)} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors w-20 ${page.startsWith('lesson') && item.id === 'dashboard' ? 'text-sky-500 bg-sky-50 dark:bg-sky-900/50' : page === item.id ? 'text-sky-500 bg-sky-50 dark:bg-sky-900/50' : 'text-slate-600 dark:text-slate-300'}`}><item.icon size={22} /><span className="text-xs font-medium">{item.label}</span></button>
              ))}
            </div>
        </footer>
      </div>
    </div>
  );
}
